trigger:
  - azure-pipelines-all

variables:
  # Define global variables
  ISO_DATE: '' # Will be dynamically set

stages:
  - stage: initialize
    displayName: "Initialize Variables"
    jobs:
      - job: set_variables
        pool:
          vmImage: "ubuntu-latest"
        steps:
          - checkout: none # Skip repository checkout
          - script: |
              isodate=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
              echo "ISO_DATE: $(isodate)"
              echo "##vso[task.setvariable variable=ISO_DATE;isOutput=true]xx$(isodate)xx"
            displayName: "Generate ISO_DATE"
            name: iso_date

  - stage: linux
    dependsOn: initialize
    variables:
      ISO_DATE: $[ stageDependencies.initialize.set_variables.outputs['iso_date.ISO_DATE'] ] # Reference output variable
    jobs:
      - job: build
        pool:
          vmImage: "ubuntu-latest"
        container: gsalsero/quake3e-linux-builder:latest
        steps:
          - script: |
              echo "ISO_DATE: $ISO_DATE"
              make CFLAGS="$CFLAGS -DISO_DATE=\"$ISO_DATE\" -DBUILD_ID=$(Build.BuildId)"
            displayName: "Build quake3e"
          - task: CopyFiles@2
            inputs:
              SourceFolder: "build/release-linux-x86_64/"
              Contents: |
                quake3e.ded.x64
                quake3e.x64
              TargetFolder: "build/release-linux-x86_64/archive"
              CleanTargetFolder: true
              preserveTimestamp: true
          - task: ArchiveFiles@2
            inputs:
              rootFolderOrFile: build/release-linux-x86_64/archive
              includeRootFolder: false
              archiveType: "zip"
              archiveFile: "$(Build.ArtifactStagingDirectory)/quake3e-release-linux-x86_64-$(Build.BuildId).zip"
              replaceExistingArchive: true
          - task: PublishPipelineArtifact@1
            inputs:
              targetPath: "$(Build.ArtifactStagingDirectory)"
              publishLocation: "pipeline"

  - stage: windows64
    dependsOn: initialize
    variables:
      ISO_DATE: $[ stageDependencies.initialize.set_variables.outputs['iso_date.ISO_DATE'] ] # Reference output variable

    jobs:
      # Standard DirectX Build
      - job: build_directx
        displayName: "Build quake3e - DirectX Backend"
        pool:
          vmImage: "windows-latest"
        steps:
          - powershell: |
              Get-ChildItem -Path 'code\win32\msvc2017' -Recurse -Filter *.vcxproj |
              ForEach-Object {
                  (Get-Content $_.FullName) -replace '<PlatformToolset>v141</PlatformToolset>', '<PlatformToolset>v143</PlatformToolset>' | Set-Content $_.FullName
              }
            displayName: "Retarget platform toolset to v143"
          - task: VSBuild@1
            inputs:
              solution: "code/win32/msvc2017/quake3e.sln"
              msbuildArgs: "/p:ISO_DATE=$(ISO_DATE) /p:BUILD_ID=$(Build.BuildId)"
              platform: "Win64"
              configuration: "Release"
              maximumCpuCount: true
              msbuildArchitecture: "x64"
          - task: CopyFiles@2
            inputs:
              SourceFolder: 'code\win32\msvc2017\output\'
              Contents: "*.exe"
              TargetFolder: 'code\win32\msvc2017\output\archive'
              CleanTargetFolder: true
              preserveTimestamp: true

          - task: ArchiveFiles@2
            inputs:
              rootFolderOrFile: code\win32\msvc2017\output\archive
              includeRootFolder: false
              archiveType: "zip"
              archiveFile: "$(Build.ArtifactStagingDirectory)/quake3e-release-win-directx-x64-$(Build.BuildId).zip"
              replaceExistingArchive: true
          - task: PublishPipelineArtifact@1
            inputs:
              targetPath: "$(Build.ArtifactStagingDirectory)"
              publishLocation: "pipeline"

      # Vulkan Backend Build
      - job: build_vulkan
        displayName: "Build quake3e - Vulkan Backend"
        pool:
          vmImage: "windows-latest"
        steps:
          - powershell: |
              Get-ChildItem -Path 'code\win32\msvc2017' -Recurse -Filter *.vcxproj |
              ForEach-Object {
                  (Get-Content $_.FullName) -replace '<PlatformToolset>v141</PlatformToolset>', '<PlatformToolset>v143</PlatformToolset>' | Set-Content $_.FullName
              }
            displayName: "Retarget platform toolset to v143"
          - task: VSBuild@1
            inputs:
              solution: "code/win32/msvc2017/quake3e.sln"
              msbuildArgs: "/p:ProjectDependencies=renderervk /p:ISO_DATE=$(ISO_DATE) /p:BUILD_ID=$(Build.BuildId)"
              platform: "Win64"
              configuration: "Release"
              maximumCpuCount: true
              msbuildArchitecture: "x64"

          - task: CopyFiles@2
            inputs:
              SourceFolder: 'code\win32\msvc2017\output\'
              Contents: "*.exe"
              TargetFolder: 'code\win32\msvc2017\output\archive'
              CleanTargetFolder: true
              preserveTimestamp: true

          - powershell: |
              cd code\win32\msvc2017\output\archive
              Get-ChildItem -Filter *.exe | ForEach-Object {
                  if ($_.Name -match "^(quake3e)(\.ded)?(\.x64\.exe)$") {
                      $newName = $matches[1] + "-vulkan" + $matches[2] + $matches[3]
                      Rename-Item -Path $_.FullName -NewName $newName
                  }
              }
            displayName: "Rename files to end with -vulkan.x64.exe"

          - task: ArchiveFiles@2
            inputs:
              rootFolderOrFile: code\win32\msvc2017\output\archive
              includeRootFolder: false
              archiveType: "zip"
              archiveFile: "$(Build.ArtifactStagingDirectory)/quake3e-release-win-vulkan-x64-$(Build.BuildId).zip"
              replaceExistingArchive: true
          - task: PublishPipelineArtifact@1
            inputs:
              targetPath: "$(Build.ArtifactStagingDirectory)"
              publishLocation: "pipeline"
# - stage: macOS
#   jobs:
#   - job: build
#     pool:
#       vmImage: 'macos-14-arm64'
#     steps:
#     - script: |
#         make
#         ls -R
#       displayName: 'make quake3e'
#     # - task: ArchiveFiles@2
#     #   inputs:
#     #     rootFolderOrFile: build/release-linux-x86_64/
#     #     includeRootFolder: true
#     #     archiveType: 'zip'
#     #     archiveFile: '$(Build.ArtifactStagingDirectory)/quake3e-release-macos-arm64-$(Build.BuildId).zip'
#     #     replaceExistingArchive: true
#     # - task: PublishPipelineArtifact@1
#     #   inputs:
#     #     targetPath: '$(Build.ArtifactStagingDirectory)'
#     #     publishLocation: 'pipeline'
